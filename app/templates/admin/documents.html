{% extends "admin/base_admin.html" %}
{% block title %}Documents - Admin Dashboard{% endblock %}
{% block content %}
<div class="space-y-4 sm:space-y-6 w-full min-w-0">
  <!-- Upload Knowledge Base Document -->
  <!-- Upload / Add Section -->
  <div class="bg-slate-900 rounded-xl shadow-2xl border border-slate-800 overflow-hidden">
    <div
      class="px-4 sm:px-6 py-4 border-b border-slate-800 bg-slate-800/30 flex flex-wrap justify-between items-center gap-2">
      <h2 class="text-base sm:text-lg font-semibold text-white">Add to Knowledge Base</h2>
    </div>

    <div class="px-4 sm:px-6 py-4 border-b border-slate-800 bg-slate-800/20 flex items-center gap-2">
      <i class="fa-solid fa-file-upload text-blue-400"></i>
      <h3 class="text-sm font-semibold text-slate-200">Upload Knowledge Base Document</h3>
    </div>

    <div class="p-4 sm:p-6">

      <!-- File Upload Form -->
      <div id="panel-file" class="block">
        <form id="upload-form" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-400 mb-1">Course</label>
              <select name="course" id="upload-course" required
                class="w-full px-3 py-2 bg-slate-950 border border-slate-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm text-white">
                <option value="">Select Course</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-400 mb-1">Semester</label>
              <select name="semester" id="upload-semester" required
                class="w-full px-3 py-2 bg-slate-950 border border-slate-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm text-white">
                <option value="">Select Semester</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-400 mb-1">Subject</label>
              <select name="subject" id="upload-subject" required
                class="w-full px-3 py-2 bg-slate-950 border border-slate-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm text-white">
                <option value="">Select Subject</option>
              </select>
            </div>
          </div>
          <label for="file-input"
            class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-800 border-dashed rounded-lg cursor-pointer bg-slate-950 hover:bg-slate-900 transition-colors group">
            <div class="flex flex-col items-center justify-center pt-4 pb-5">
              <i
                class="fa-solid fa-cloud-upload-alt text-2xl text-slate-600 mb-2 group-hover:text-indigo-400 transition-colors"></i>
              <p class="mb-1 text-sm text-slate-500"><span class="font-bold text-slate-300">Click to upload</span> (PDF,
                DOCX, PPTX)
              </p>
            </div>
            <input id="file-input" type="file" class="hidden" accept=".pdf,.docx,.pptx" />
          </label>
          <p id="file-name" class="mt-1 text-xs text-center text-slate-500 font-medium h-4"></p>
          <div class="flex justify-end">
            <button type="submit" class="btn-primary inline-flex items-center gap-2">
              <i class="fa-solid fa-upload"></i> Upload & Process
            </button>
          </div>
        </form>
        <div id="upload-status" class="mt-4 text-sm font-medium text-center"></div>
      </div>



    </div>
  </div>

  <div class="bg-slate-900 rounded-xl shadow-2xl border border-slate-800 p-4 sm:p-4">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
      <div class="sm:col-span-2 lg:col-span-1">
        <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Search</label>
        <div class="relative"><span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i
              class="fa-solid fa-search text-slate-600"></i></span><input type="text" id="search-filter"
            placeholder="Search..."
            class="w-full pl-10 pr-3 py-2 bg-slate-950 border border-slate-800 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-0">
        </div>
      </div>
      <div class="w-full min-w-0">
        <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Course</label>
        <select id="course-filter"
          class="w-full px-3 py-2 bg-slate-950 border border-slate-800 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-0">
          <option value="">All Courses</option>
        </select>
      </div>
      <div class="w-full min-w-0">
        <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Semester</label>
        <select id="sem-filter"
          class="w-full px-3 py-2 bg-slate-950 border border-slate-800 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-0">
          <option value="">All Semesters</option>
        </select>
      </div>
      <div class="w-full min-w-0">
        <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Subject</label>
        <select id="subj-filter"
          class="w-full px-3 py-2 bg-slate-950 border border-slate-800 rounded-lg text-sm text-white focus:outline-none focus:ring-2 focus:ring-purple-500 min-w-0">
          <option value="">All Subjects</option>
        </select>
      </div>
    </div>
  </div>
  <div class="bg-slate-900 rounded-xl shadow-2xl border border-slate-800 overflow-hidden min-w-0">
    <div
      class="px-4 sm:px-6 py-4 border-b border-slate-800 bg-slate-800/30 flex flex-wrap justify-between items-center gap-2">
      <h2 class="text-base sm:text-lg font-semibold text-white truncate min-w-0">Uploaded Documents</h2>
      <button type="button" onclick="loadDocs()" class="btn-icon shrink-0 text-slate-300 hover:text-white"
        title="Refresh list"><i class="fa-solid fa-sync-alt"></i> Refresh</button>
    </div>
    <div class="overflow-x-auto hide-h-scrollbar">
      <table class="min-w-full divide-y divide-slate-800">
        <thead class="bg-slate-800/50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest min-w-[200px]">
              Filename
            </th>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest w-32">Course
            </th>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest w-24">Semester
            </th>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest w-24">Subject
            </th>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest w-32">Status
            </th>
            <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest">Upload Date
            </th>
            <th class="px-6 py-3 text-right text-xs font-black text-slate-500 uppercase tracking-widest w-40">Actions
            </th>
          </tr>
        </thead>
        <tbody id="doc-list" class="bg-slate-900 divide-y divide-slate-800"></tbody>
      </table>
      <div id="empty-state" class="hidden py-12 text-center">
        <i class="fa-solid fa-file-invoice text-4xl text-slate-700 mb-4 opacity-50"></i>
        <p class="text-slate-500 font-medium">No documents found matching filters.</p>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  let allDocs = [];
  let allFilters = [];



  // --- Upload form: load filter options and populate dropdowns ---
  async function loadFilterOptions() {
    try {
      const res = await fetch('/api/admin/filter-options');
      const data = await res.json();
      allFilters = data.all || [];
      initUploadForm();
    } catch (e) { console.error('Error loading filter options', e); }
  }

  function initUploadForm() {
    const cSelect = document.getElementById('upload-course');
    const sSelect = document.getElementById('upload-semester');
    if (!cSelect) return;
    const courses = allFilters.filter(x => x.category === 'course').sort((a, b) => a.value.localeCompare(b.value));
    uploadPopulateSelect(cSelect, courses, 'Select Course');
    cSelect.onchange = () => updateSemesters('upload');
    if (sSelect) sSelect.onchange = () => updateSubjects('upload');
    updateSemesters('upload');
  }



  function updateSemesters(prefix) {
    const cSelect = document.getElementById(prefix + '-course');
    const sSelect = document.getElementById(prefix + '-semester');
    const subSelect = document.getElementById(prefix + '-subject');
    if (!sSelect) return;

    const curS = sSelect.value;
    sSelect.innerHTML = '<option value="">Select Semester</option>';
    if (subSelect) subSelect.innerHTML = '<option value="">Select Subject</option>';

    const cVal = cSelect ? cSelect.value : '';
    const courseObj = allFilters.find(x => x.category === 'course' && x.value === cVal);
    let semesters = courseObj
      ? allFilters.filter(x => x.category === 'semester' && x.parent_id === courseObj.id)
      : allFilters.filter(x => x.category === 'semester');
    semesters = semesters.sort((a, b) => a.value.localeCompare(b.value));
    uploadPopulateSelect(sSelect, semesters, 'Select Semester');
    // Attempt to preserve value if valid
    if (curS && Array.from(sSelect.options).some(o => o.value === curS)) sSelect.value = curS;
  }

  function updateSubjects(prefix) {
    const cSelect = document.getElementById(prefix + '-course');
    const sSelect = document.getElementById(prefix + '-semester');
    const subSelect = document.getElementById(prefix + '-subject');
    if (!subSelect) return;

    const curSub = subSelect.value;
    subSelect.innerHTML = '<option value="">Select Subject</option>';

    const sVal = sSelect ? sSelect.value : '';
    const cVal = cSelect ? cSelect.value : '';
    const courseObj = allFilters.find(x => x.category === 'course' && x.value === cVal);
    const semObj = sVal && courseObj
      ? allFilters.find(x => x.category === 'semester' && x.value === sVal && x.parent_id === courseObj.id)
      : (sVal ? allFilters.find(x => x.category === 'semester' && x.value === sVal) : null);

    let subjects = semObj
      ? allFilters.filter(x => x.category === 'subject' && x.parent_id === semObj.id)
      : allFilters.filter(x => x.category === 'subject');
    subjects = subjects.sort((a, b) => a.value.localeCompare(b.value));
    uploadPopulateSelect(subSelect, subjects, 'Select Subject');
    if (curSub && Array.from(subSelect.options).some(o => o.value === curSub)) subSelect.value = curSub;
  }

  function uploadPopulateSelect(el, items, placeholder) {
    if (!el) return;
    el.innerHTML = '<option value="">' + placeholder + '</option>';
    items.forEach(i => {
      const opt = document.createElement('option');
      opt.value = i.value;
      opt.textContent = i.value;
      el.appendChild(opt);
    });
  }

  async function loadDocs() {
    const tbody = document.getElementById('doc-list');
    tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-slate-500 font-medium">Scanning knowledge assets...</td></tr>';
    try {
      const res = await fetch('/api/admin/documents');
      const data = await res.json();
      // Filter out web sources for this page
      allDocs = (data || []).filter(d => !(d.filename || '').startsWith('[WEB] '));

      const courses = [...new Set(allDocs.map(d => d.course).filter(Boolean))].sort();
      const courseSelect = document.getElementById('course-filter');
      courseSelect.innerHTML = '<option value="">All Courses</option>';
      courses.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c; opt.textContent = c;
        courseSelect.appendChild(opt);
      });

      const semesters = [...new Set(allDocs.map(d => d.semester).filter(Boolean))].sort();
      const semSelect = document.getElementById('sem-filter');
      semSelect.innerHTML = '<option value="">All Semesters</option>';
      semesters.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s;
        semSelect.appendChild(opt);
      });

      const subjects = [...new Set(allDocs.map(d => d.subject).filter(Boolean))].sort();
      const subjSelect = document.getElementById('subj-filter');
      if (subjSelect) {
        subjSelect.innerHTML = '<option value="">All Subjects</option>';
        subjects.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s; opt.textContent = s;
          subjSelect.appendChild(opt);
        });
      }
      renderDocs();
    } catch (e) {
      tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Error loading documents</td></tr>';
    }
  }
  function renderDocs() {
    const tbody = document.getElementById('doc-list');
    const emptyState = document.getElementById('empty-state');
    const search = document.getElementById('search-filter').value.toLowerCase();
    const course = document.getElementById('course-filter').value;
    const sem = document.getElementById('sem-filter').value;
    const subj = document.getElementById('subj-filter') ? document.getElementById('subj-filter').value : '';

    const filtered = allDocs.filter(doc => {
      // Don't show web sources in the general documents tab
      if (doc.filename.startsWith('[WEB] ')) return false;

      const matchesSearch = doc.filename.toLowerCase().includes(search);
      const matchesCourse = !course || doc.course === course;
      const matchesSem = !sem || doc.semester === sem;
      const matchesSubj = !subj || doc.subject === subj;
      return matchesSearch && matchesCourse && matchesSem && matchesSubj;
    });

    tbody.innerHTML = '';
    if (filtered.length === 0) {
      emptyState.classList.remove('hidden');
    } else {
      emptyState.classList.add('hidden');
      filtered.forEach(doc => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-800/40 transition-colors group';
        let statusClass = 'bg-slate-800 text-slate-400 border border-slate-700';
        let statusIcon = 'fa-circle';
        if (doc.status === 'processed') {
          statusClass = 'bg-emerald-500/10 text-emerald-400 border border-emerald-500/20';
          statusIcon = 'fa-check-circle';
        } else if (doc.status === 'error') {
          statusClass = 'bg-red-500/10 text-red-400 border border-red-500/20';
          statusIcon = 'fa-exclamation-circle';
        } else if (doc.status === 'pending') {
          statusClass = 'bg-amber-500/10 text-amber-500 border border-amber-500/20';
          statusIcon = 'fa-clock';
        }

        const date = doc.upload_date ? new Date(doc.upload_date).toLocaleDateString() : 'N/A';
        const courseBadge = `<span class="px-2 py-0.5 inline-flex text-[10px] font-black uppercase tracking-widest rounded-full ${doc.course ? 'bg-indigo-500/10 text-indigo-400 border border-indigo-500/20' : 'bg-slate-800 text-slate-500 border border-slate-700'}">${doc.course || 'Unknown'}</span>`;
        const semBadge = `<span class="px-2 py-0.5 inline-flex text-[10px] font-black uppercase tracking-widest rounded-full ${doc.semester ? 'bg-violet-500/10 text-violet-400 border border-violet-500/20' : 'bg-slate-800 text-slate-500 border border-slate-700'}">${doc.semester || 'Unknown'}</span>`;
        const subjBadge = `<span class="px-2 py-0.5 inline-flex text-[10px] font-black uppercase tracking-widest rounded-full ${doc.subject ? 'bg-purple-500/10 text-purple-400 border border-purple-500/20' : 'bg-slate-800 text-slate-500 border border-slate-700'}">${doc.subject || 'Unknown'}</span>`;

        tr.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10 bg-indigo-500/10 rounded-lg flex items-center justify-center text-indigo-400 border border-indigo-500/20">
                <i class="fa-solid fa-file-alt"></i>
              </div>
              <div class="ml-4">
                <div class="text-sm font-bold text-white">${doc.filename}</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-medium">${courseBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-medium">${semBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-medium">${subjBadge}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 inline-flex text-[10px] font-black uppercase tracking-tighter rounded-full items-center ${statusClass}">
              <i class="fas ${statusIcon} mr-1.5 text-[8px]"></i> ${doc.status}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-medium">${date}</td>
          <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
            <a href="/admin/chunks?document_id=${doc.id}" class="btn-link"><i class="fa-solid fa-layer-group"></i> View chunks</a>
            <button type="button" onclick="deleteDoc(${doc.id})" class="btn-danger-ghost inline-flex items-center gap-1.5" title="Delete document and its chunks"><i class="fa-solid fa-trash-alt"></i> Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
  }

  async function deleteDoc(id) {
    if (!confirm('Are you sure you want to delete this document and all its chunks? This cannot be undone.')) return;
    try {
      const res = await fetch(`/api/admin/documents/${id}`, { method: 'DELETE' });
      if (res.ok) {
        allDocs = allDocs.filter(d => d.id !== id);
        renderDocs();
      } else {
        alert('Failed to delete document');
      }
    } catch (e) {
      alert('Error deleting document');
    }
  }

  // Upload form: file name display and submit
  const fileInput = document.getElementById('file-input');
  if (fileInput) fileInput.addEventListener('change', function () {
    const fn = document.getElementById('file-name');
    if (fn) fn.innerText = this.files.length > 0 ? this.files[0].name : '';
  });
  const uploadForm = document.getElementById('upload-form');
  if (uploadForm) uploadForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    const status = document.getElementById('upload-status');
    const courseVal = (document.getElementById('upload-course') && document.getElementById('upload-course').value || '').trim();
    const semVal = (document.getElementById('upload-semester') && document.getElementById('upload-semester').value || '').trim();
    const subjVal = (document.getElementById('upload-subject') && document.getElementById('upload-subject').value || '').trim();
    if (!courseVal || !semVal || !subjVal) {
      status.innerText = 'Course, Semester, and Subject are required';
      status.className = 'mt-4 text-sm text-center text-red-400 font-bold';
      return;
    }
    if (!fileInput || fileInput.files.length === 0) {
      status.innerText = 'Please select a file to upload';
      status.className = 'mt-4 text-sm text-center text-red-400 font-bold';
      return;
    }
    const formData = new FormData(uploadForm);
    formData.append('file', fileInput.files[0]);
    status.innerText = 'Uploading...';
    status.className = 'mt-4 text-sm text-center text-indigo-400 font-bold animate-pulse';
    try {
      const res = await fetch('/api/admin/upload', { method: 'POST', body: formData });
      const data = await res.json();
      if (res.ok) {
        status.innerText = 'Success! File processed.';
        status.className = 'mt-4 text-sm text-center text-emerald-400 font-bold';
        fileInput.value = '';
        const fn = document.getElementById('file-name');
        if (fn) fn.innerText = '';
        loadDocs();
        setTimeout(function () { status.innerText = ''; }, 3000);
      } else {
        status.innerText = data.error || 'Upload failed';
        status.className = 'mt-4 text-sm text-center text-red-400 font-bold';
      }
    } catch (err) {
      status.innerText = 'Network error';
      status.className = 'mt-4 text-sm text-center text-red-600';
    }
  });

  const websiteForm = document.getElementById('website-form');
  if (websiteForm) websiteForm.addEventListener('submit', async function (e) {
    e.preventDefault();
    const status = document.getElementById('web-status');
    const btn = document.getElementById('web-submit-btn');

    const urlVal = (document.getElementById('web-url') && document.getElementById('web-url').value || '').trim();

    if (!urlVal) {
      status.innerText = 'URL is required';
      status.className = 'mt-4 text-sm text-center text-red-600';
      return;
    }

    status.innerText = 'Scraping and indexing... This may take up to 60 seconds.';
    status.className = 'mt-4 text-sm text-center text-blue-600 animate-pulse';
    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Processing...';

    try {
      const res = await fetch('/api/admin/add-website', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          url: urlVal
        })
      });
      const data = await res.json();
      if (res.ok) {
        status.innerText = data.message || 'Success! Website processed.';
        status.className = 'mt-4 text-sm text-center text-green-600';
        document.getElementById('web-url').value = '';
        loadDocs();
        setTimeout(function () { status.innerText = ''; }, 5000);
      } else {
        status.innerText = data.error || 'Scraping failed';
        status.className = 'mt-4 text-sm text-center text-red-600';
      }
    } catch (err) {
      status.innerText = 'Network error: ' + err.message;
      status.className = 'mt-4 text-sm text-center text-red-600';
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fa-solid fa-robot"></i> Scrape & Index';
    }
  });



  // Initial load: filter options for upload dropdowns, then documents list
  loadFilterOptions().then(function () { loadDocs(); });

  // Listeners
  document.getElementById('course-filter').addEventListener('change', () => renderDocs());
  document.getElementById('sem-filter').addEventListener('change', () => renderDocs());
  const subjSelectEl = document.getElementById('subj-filter');
  if (subjSelectEl) {
    subjSelectEl.addEventListener('change', () => renderDocs());
  }
  document.getElementById('search-filter').addEventListener('input', () => renderDocs());
</script>
{% endblock %}