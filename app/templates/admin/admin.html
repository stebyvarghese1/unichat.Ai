{% extends "admin/base_admin.html" %}
{% block title %}Admin Dashboard{% endblock %}
{% block content %}
<div class="space-y-6">
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
<div class="bg-white rounded-xl shadow-sm p-6 flex items-center space-x-4 border border-gray-100">
<div class="p-3 bg-blue-100 text-blue-600 rounded-lg"><i class="fas fa-cubes text-xl"></i></div>
<div><p class="text-sm font-medium text-gray-500">Total Vectors</p><p id="vector-count" class="text-2xl font-bold text-gray-800">Loading...</p></div>
</div>
<div class="bg-white rounded-xl shadow-sm p-6 flex items-center space-x-4 border border-gray-100">
<div class="p-3 bg-indigo-100 text-indigo-600 rounded-lg"><i class="fas fa-ruler-combined text-xl"></i></div>
<div><p class="text-sm font-medium text-gray-500">Vector Dimension</p><p id="vector-dim" class="text-2xl font-bold text-gray-800">Loading...</p></div>
</div>
<div class="bg-white rounded-xl shadow-sm p-6 flex items-center space-x-4 border border-gray-100">
<div class="p-3 bg-green-100 text-green-600 rounded-lg"><i class="fas fa-server text-xl"></i></div>
<div><p class="text-sm font-medium text-gray-500">System Status</p><p class="text-2xl font-bold text-gray-800">Online</p></div>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
<div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
<div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center"><h2 class="text-lg font-semibold text-gray-800">Upload Knowledge</h2><span class="text-xs font-medium px-2 py-1 bg-blue-100 text-blue-700 rounded">PDF, DOCX, PPTX</span></div>
<div class="p-6">
<form id="upload-form" class="space-y-4">
<div class="grid grid-cols-3 gap-4">
<div><label class="block text-sm font-medium text-gray-700 mb-1">Course</label><input type="text" name="course" placeholder="e.g. CS101" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
<div><label class="block text-sm font-medium text-gray-700 mb-1">Semester</label><input type="text" name="semester" placeholder="e.g. Sem 1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
<div><label class="block text-sm font-medium text-gray-700 mb-1">Subject</label><input type="text" name="subject" placeholder="e.g. Data Structures" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
</div>
<label for="file-input" class="flex flex-col items-center justify-center w-full h-48 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
<div class="flex flex-col items-center justify-center pt-5 pb-6"><i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i><p class="mb-2 text-sm text-gray-500"><span class="font-semibold">Click to upload</span> or drag and drop</p><p class="text-xs text-gray-500">Supported formats: PDF, DOCX, PPTX</p></div>
<input id="file-input" type="file" class="hidden" accept=".pdf,.docx,.pptx" />
</label>
<p id="file-name" class="mt-2 text-sm text-center text-gray-600 font-medium h-5"></p>
<div class="flex justify-end"><button type="submit" class="px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 transition-all flex items-center"><i class="fas fa-upload mr-2"></i> Upload & Process</button></div>
</form>
<div id="upload-status" class="mt-4 text-sm font-medium text-center"></div>
</div>
</div>
<div class="bg-white rounded-xl shadow-sm border border-gray-100">
<div class="px-6 py-4 border-b border-gray-100 bg-gray-50"><h2 class="text-lg font-semibold text-gray-800">Maintenance</h2></div>
<div class="p-6 space-y-4">
<div class="p-4 bg-yellow-50 rounded-lg border border-yellow-100"><h3 class="font-semibold text-yellow-800 mb-1">Rebuild Index</h3><p class="text-xs text-yellow-700 mb-3">Clear and regenerate vector embeddings from chunks.</p><button id="rebuild-btn" class="w-full px-4 py-2 bg-yellow-600 text-white text-sm font-medium rounded hover:bg-yellow-700 transition"><i class="fas fa-sync mr-2"></i> Rebuild Index</button><p id="rebuild-status" class="mt-2 text-xs text-gray-500 text-center h-4"></p></div>
<div class="p-4 bg-blue-50 rounded-lg border border-blue-100"><h3 class="font-semibold text-blue-800 mb-1">Sync Storage</h3><p class="text-xs text-blue-700 mb-3">Scan storage for unindexed files.</p><button id="sync-btn" class="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 transition"><i class="fas fa-database mr-2"></i> Sync Storage</button><p id="sync-status" class="mt-2 text-xs text-gray-500 text-center h-4"></p></div>
<div class="p-4 bg-red-50 rounded-lg border border-red-100"><h3 class="font-semibold text-red-800 mb-1">Admin Account</h3><p class="text-xs text-red-700 mb-3">Update admin email and password.</p><button id="admin-acc-btn" class="w-full px-4 py-2 bg-red-600 text-white text-sm font-medium rounded hover:bg-red-700 transition"><i class="fas fa-user-shield mr-2"></i> Update Admin Account</button><p id="admin-acc-status" class="mt-2 text-xs text-gray-500 text-center h-4"></p></div>
</div>
</div>
</div>
</div>
{% endblock %}
{% block scripts %}
<script>
async function loadStats(){try{const res=await fetch('/api/admin/stats');const data=await res.json();document.getElementById('vector-count').innerText=data.total_vectors;document.getElementById('vector-dim').innerText=data.dimension;}catch(e){document.getElementById('vector-count').innerText='Err';document.getElementById('vector-dim').innerText='Err';}}
loadStats();
const fileInput=document.getElementById('file-input');
if(fileInput){fileInput.addEventListener('change',()=>{if(fileInput.files.length>0){document.getElementById('file-name').innerText=fileInput.files[0].name;}});}
const uploadForm=document.getElementById('upload-form');
if(uploadForm){uploadForm.addEventListener('submit',async(e)=>{e.preventDefault();const status=document.getElementById('upload-status');const courseVal=(uploadForm.querySelector('input[name=\"course\"]')?.value||'').trim();const semVal=(uploadForm.querySelector('input[name=\"semester\"]')?.value||'').trim();const subjVal=(uploadForm.querySelector('input[name=\"subject\"]')?.value||'').trim();if(!courseVal||!semVal||!subjVal){status.innerText='Course, Semester, and Subject are required';status.className='mt-4 text-sm text-center text-red-600';return;}if(fileInput.files.length===0){status.innerText='Please select a file to upload';status.className='mt-4 text-sm text-center text-red-600';return;}const formData=new FormData(uploadForm);formData.append('file',fileInput.files[0]);status.innerText='Uploading...';status.className='mt-4 text-sm text-center text-blue-600';try{const res=await fetch('/api/admin/upload',{method:'POST',body:formData});const data=await res.json();if(res.ok){status.innerText='Success! File processed.';status.className='mt-4 text-sm text-center text-green-600';loadStats();fileInput.value='';document.getElementById('file-name').innerText='';setTimeout(()=>{status.innerText='';},3000);}else{status.innerText=data.error||'Upload failed';status.className='mt-4 text-sm text-center text-red-600';}}catch(err){status.innerText='Network error';status.className='mt-4 text-sm text-center text-red-600';}});}
const rebuildBtn=document.getElementById('rebuild-btn');if(rebuildBtn){rebuildBtn.addEventListener('click',async()=>{const status=document.getElementById('rebuild-status');status.innerText='Processing...';try{const res=await fetch('/api/admin/rebuild-index',{method:'POST'});const data=await res.json();status.innerText=data.message||data.error;loadStats();setTimeout(()=>{status.innerText='';},5000);}catch(err){status.innerText='Error rebuilding index';}});}
const syncBtn=document.getElementById('sync-btn');if(syncBtn){syncBtn.addEventListener('click',async()=>{const status=document.getElementById('sync-status');status.innerText='Syncing...';try{const res=await fetch('/api/admin/sync-storage',{method:'POST'});const data=await res.json();status.innerText=data.message||data.error;loadStats();setTimeout(()=>{status.innerText='';},5000);}catch(err){status.innerText='Error syncing storage';}});}

const accBtn=document.getElementById('admin-acc-btn');
if(accBtn){
  const modal=document.createElement('div');
  modal.className='fixed inset-0 z-50 hidden';
  modal.innerHTML=`<div class="flex items-center justify-center min-h-screen p-4 bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-xl">
      <div class="px-6 py-4 border-b bg-gray-50 flex justify-between items-center">
        <h3 class="text-lg font-semibold text-gray-800">Update Admin Account</h3>
        <button id="acc-close" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times"></i></button>
      </div>
      <div class="p-6 space-y-4">
        <div><label class="block text-xs font-medium text-gray-600 mb-1">Email</label><input id="acc-email" type="email" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="admin@university.edu"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-xs font-medium text-gray-600 mb-1">Current Password</label><input id="acc-current" type="password" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="current password"></div>
          <div><label class="block text-xs font-medium text-gray-600 mb-1">New Password</label><input id="acc-new" type="password" class="w-full border border-gray-300 rounded p-2 text-sm" placeholder="new password"></div>
        </div>
        <p id="acc-msg" class="text-xs text-gray-500 h-4"></p>
      </div>
      <div class="px-6 py-4 border-t bg-gray-50 flex justify-end">
        <button id="acc-save" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded hover:bg-red-700 transition"><i class="fas fa-save mr-2"></i> Save</button>
      </div>
    </div>
  </div>`;
  document.body.appendChild(modal);
  const accStatus=document.getElementById('admin-acc-status');
  accBtn.addEventListener('click',async()=>{
    modal.classList.remove('hidden');
    const msg=document.getElementById('acc-msg');
    msg.innerText='Loading...';
    try{
      const r=await fetch('/api/admin/admin-account');
      const data=await r.json();
      document.getElementById('acc-email').value = data.email || '';
      msg.innerText='';
    }catch(e){msg.innerText='Failed to load';}
  });
  modal.querySelector('#acc-close').addEventListener('click',()=>{modal.classList.add('hidden');});
  modal.querySelector('#acc-save').addEventListener('click',async()=>{
    const msg=document.getElementById('acc-msg');
    msg.innerText='Saving...';
    const payload={
      email: document.getElementById('acc-email').value.trim(),
      current_password: document.getElementById('acc-current').value.trim() || undefined,
      new_password: document.getElementById('acc-new').value.trim() || undefined
    };
    try{
      const res=await fetch('/api/admin/admin-account',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const data=await res.json();
      if(res.ok){
        msg.innerText='Saved';
        accStatus.innerText='Admin account updated';
        accStatus.className='mt-2 text-xs text-green-600 text-center h-4';
        setTimeout(()=>{modal.classList.add('hidden');msg.innerText='';},1000);
      }else{
        msg.innerText=data.error||'Failed';
      }
    }catch(err){
      msg.innerText='Network error';
    }
  });
}
</script>
{% endblock %}
