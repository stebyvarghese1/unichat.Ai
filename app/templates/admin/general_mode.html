{% extends "admin/base_admin.html" %}
{% block title %}General Mode Management - Admin Dashboard{% endblock %}
{% block content %}
<div class="space-y-4 sm:space-y-6 w-full min-w-0">
    <!-- Header Summary / Global Settings -->
    <div class="bg-slate-900 rounded-xl shadow-2xl border border-slate-800 overflow-hidden">
        <div
            class="px-4 sm:px-6 py-4 border-b border-slate-800 bg-slate-800/30 flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-400 border border-indigo-500/20">
                    <i class="fa-solid fa-cog text-lg"></i>
                </div>
                <div>
                    <h1 class="text-base sm:text-lg font-semibold text-white">General Mode Settings</h1>
                    <p class="text-xs text-slate-500 font-medium">Manage AI search sources and system behavior.</p>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-3">
                <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-950 border border-slate-800 rounded-lg">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Live Search</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="general-live-mode" class="sr-only peer">
                        <div
                            class="w-9 h-5 bg-slate-800 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2.5px] after:left-[2.5px] after:bg-white after:border-slate-600 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600">
                        </div>
                    </label>
                </div>

                <div class="flex items-center gap-2 px-3 py-1.5 bg-slate-950 border border-slate-800 rounded-lg">
                    <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Auto-Sync</span>
                    <select id="general-refresh-interval"
                        class="text-xs border-none focus:ring-0 p-0 bg-transparent text-indigo-400 font-bold cursor-pointer">
                        <option value="never">Never</option>
                        <option value="1">Daily</option>
                        <option value="7">Weekly</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Source Addition Section -->
    <div class="bg-slate-900 rounded-xl shadow-2xl border border-slate-800 overflow-hidden">
        <div class="px-4 sm:px-6 py-4 border-b border-slate-800 bg-slate-800/30 flex items-center gap-2">
            <i class="fa-solid fa-plus-circle text-indigo-400"></i>
            <h3 class="text-sm font-semibold text-slate-200">Add New Website Source</h3>
        </div>

        <div class="p-4 sm:p-6 space-y-4">
            <div class="grid grid-cols-1 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-1">Website URL</label>
                    <div class="relative">
                        <span
                            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-600">
                            <i class="fa-solid fa-globe text-sm"></i>
                        </span>
                        <input type="url" id="universal-url-input" placeholder="https://example.com/knowledge"
                            class="w-full pl-10 pr-3 py-2 bg-slate-950 border border-slate-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm text-white">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <label
                        class="flex items-center gap-2 px-3 py-3 border border-slate-800 bg-slate-800/20 rounded-lg cursor-pointer hover:bg-slate-800/40 transition-colors">
                        <input type="checkbox" id="check-search"
                            class="w-4 h-4 text-indigo-600 rounded border-slate-700 bg-slate-900 focus:ring-indigo-500"
                            checked>
                        <div>
                            <span class="block text-xs font-bold text-slate-200">Enable Real-time Search</span>
                            <span class="text-[10px] text-slate-500">Quick-browse during conversations</span>
                        </div>
                    </label>

                    <label
                        class="flex items-center gap-2 px-3 py-3 border border-slate-800 bg-slate-800/20 rounded-lg cursor-pointer hover:bg-slate-800/40 transition-colors">
                        <input type="checkbox" id="check-index"
                            class="w-4 h-4 text-indigo-600 rounded border-slate-700 bg-slate-900 focus:ring-indigo-500">
                        <div>
                            <span class="block text-xs font-bold text-slate-200">Index for Knowledge Base</span>
                            <span class="text-[10px] text-slate-500">Deep-crawl & permanent storage</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 pt-2">
                <div id="action-status" class="text-sm font-medium"></div>
                <button id="process-source-btn"
                    class="btn-primary flex items-center justify-center gap-2 w-full sm:w-auto">
                    <i class="fa-solid fa-save"></i>
                    <span>Apply & Save All</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Management Console -->
    <div class="bg-slate-900 rounded-xl shadow-2xl border border-slate-800 overflow-hidden">
        <div
            class="px-4 sm:px-6 py-4 border-b border-slate-800 bg-slate-800/30 flex flex-wrap justify-between items-center gap-2">
            <div class="flex p-1 bg-slate-950 border border-slate-800 rounded-lg">
                <button onclick="switchTab('active')" id="tab-active"
                    class="px-4 py-1.5 rounded-md text-xs font-bold uppercase tracking-wider transition-all bg-slate-800 text-indigo-400 shadow-lg">
                    Active Search
                </button>
                <button onclick="switchTab('indexed')" id="tab-indexed"
                    class="px-4 py-1.5 rounded-md text-xs font-bold uppercase tracking-wider text-slate-500 hover:text-slate-300 transition-all">
                    Indexed Database
                </button>
            </div>

            <div class="flex items-center gap-3">
                <div id="item-count" class="text-xs font-black text-slate-600 uppercase tracking-widest">0 ITEMS</div>
                <button onclick="refreshData()" class="btn-icon text-slate-400 hover:text-white" title="Refresh data">
                    <i class="fa-solid fa-sync-alt"></i>
                </button>
            </div>
        </div>

        <!-- Active Links Tab -->
        <div id="content-active" class="block">
            <div class="p-4 sm:p-6">
                <div id="general-urls-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    <!-- Dynamic Content -->
                </div>
                <div id="active-empty" class="hidden py-12 text-center text-slate-600">
                    <i class="fa-solid fa-search-location text-3xl mb-2 opacity-20"></i>
                    <p class="text-sm font-medium">No active search links configured.</p>
                </div>
            </div>
        </div>

        <!-- Indexed KB Tab -->
        <div id="content-indexed" class="hidden overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-800">
                <thead class="bg-slate-800/50 focus:outline-none">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest">
                            Source Document</th>
                        <th class="px-6 py-3 text-center text-xs font-black text-slate-500 uppercase tracking-widest">
                            Status</th>
                        <th class="px-6 py-3 text-right text-xs font-black text-slate-500 uppercase tracking-widest">
                            Actions</th>
                    </tr>
                </thead>
                <tbody id="web-list" class="bg-slate-900 divide-y divide-slate-800">
                    <!-- Dynamic Content -->
                </tbody>
            </table>
            <div id="indexed-empty" class="hidden py-12 text-center text-slate-600">
                <i class="fa-solid fa-database text-3xl mb-2 opacity-20"></i>
                <p class="text-sm font-medium">No documents have been indexed to memory.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let generalConfig = { urls: [], live: false };

    async function refreshData() {
        const activeTab = document.getElementById('content-active').classList.contains('hidden') ? 'indexed' : 'active';
        await loadGeneralConfig();
        if (activeTab === 'indexed') await loadDocs();
        setStatus('Synced', 'success');
    }

    function switchTab(tab) {
        const activeTabBtn = document.getElementById('tab-active');
        const indexedTabBtn = document.getElementById('tab-indexed');
        const activeContent = document.getElementById('content-active');
        const indexedContent = document.getElementById('content-indexed');

        if (tab === 'active') {
            activeTabBtn.className = 'px-4 py-1.5 rounded-md text-xs font-bold uppercase tracking-wider transition-all bg-slate-800 text-indigo-400 shadow-lg';
            indexedTabBtn.className = 'px-4 py-1.5 rounded-md text-xs font-bold uppercase tracking-wider text-slate-500 hover:text-slate-300 transition-all';
            activeContent.classList.remove('hidden');
            indexedContent.classList.add('hidden');
            updateCount(generalConfig.urls?.length || 0);
        } else {
            indexedTabBtn.className = 'px-4 py-1.5 rounded-md text-xs font-bold uppercase tracking-wider transition-all bg-slate-800 text-indigo-400 shadow-lg';
            activeTabBtn.className = 'px-4 py-1.5 rounded-md text-xs font-bold uppercase tracking-wider text-slate-500 hover:text-slate-300 transition-all';
            indexedContent.classList.remove('hidden');
            activeContent.classList.add('hidden');
            loadDocs();
        }
    }

    function updateCount(count) {
        document.getElementById('item-count').innerText = `${count} ${count === 1 ? 'SOURCE' : 'SOURCES'}`;
    }

    async function setStatus(msg, type = 'info') {
        const el = document.getElementById('action-status');
        if (!el) return;
        el.innerText = msg;
        el.className = `text-sm font-semibold ${type === 'success' ? 'text-green-600' : type === 'error' ? 'text-red-600' : 'text-blue-600'
            }`;
        if (type === 'success') setTimeout(() => { el.innerText = ''; }, 3000);
    }

    async function loadGeneralConfig() {
        try {
            const res = await fetch('/api/admin/general-website');
            const data = await res.json();
            generalConfig = data;
            renderGeneralUrls();
            document.getElementById('general-live-mode').checked = data.live;
            document.getElementById('general-refresh-interval').value = data.refresh || 'never';
            if (!document.getElementById('content-active').classList.contains('hidden')) {
                updateCount(data.urls?.length || 0);
            }
        } catch (e) { console.error('Config failed', e); }
    }

    function renderGeneralUrls() {
        const list = document.getElementById('general-urls-list');
        const empty = document.getElementById('active-empty');
        if (!list) return;
        list.innerHTML = '';

        const urls = generalConfig.urls || [];
        if (urls.length === 0) {
            empty.classList.remove('hidden');
            return;
        }
        empty.classList.add('hidden');

        urls.forEach((url, idx) => {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 bg-slate-950 border border-slate-800 rounded-lg shadow-sm hover:border-indigo-500/50 transition-all group';
            div.innerHTML = `
                <div class="flex items-center gap-3 min-w-0">
                  <div class="w-7 h-7 flex-shrink-0 flex items-center justify-center rounded bg-slate-900 text-[10px] font-bold text-slate-500 border border-slate-800 group-hover:bg-indigo-500/10 group-hover:text-indigo-400 transition-all font-mono">${idx + 1}</div>
                  <div class="min-w-0">
                    <span class="text-sm text-slate-200 font-bold truncate block">${url}</span>
                  </div>
                </div>
                <button type="button" onclick="removeGeneralUrl(${idx})" class="w-8 h-8 flex items-center justify-center text-slate-600 hover:text-red-400 hover:bg-red-500/10 rounded-md transition-all">
                  <i class="fa-solid fa-trash-alt text-xs"></i>
                </button>
            `;
            list.appendChild(div);
        });
    }

    function removeGeneralUrl(idx) {
        if (!confirm('Remove this search link?')) return;
        generalConfig.urls.splice(idx, 1);
        renderGeneralUrls();
        updateCount(generalConfig.urls.length);
    }

    document.getElementById('process-source-btn').addEventListener('click', async () => {
        const btn = document.getElementById('process-source-btn');
        const urlInput = document.getElementById('universal-url-input');
        const url = urlInput.value.trim();
        const doSearch = document.getElementById('check-search').checked;
        const doIndex = document.getElementById('check-index').checked;

        const oldContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Processing...';
        setStatus('Processing request...', 'info');

        try {
            if (url && doSearch) {
                if (!generalConfig.urls) generalConfig.urls = [];
                if (!generalConfig.urls.includes(url)) {
                    generalConfig.urls.push(url);
                    renderGeneralUrls();
                    updateCount(generalConfig.urls.length);
                }
            }

            let indexSuccess = true;
            if (url && doIndex) {
                try {
                    const scrapeRes = await fetch('/api/admin/add-website', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });
                    if (!scrapeRes.ok) indexSuccess = false;
                } catch (e) { indexSuccess = false; }
            }

            const payload = {
                urls: generalConfig.urls,
                live: document.getElementById('general-live-mode').checked,
                refresh: document.getElementById('general-refresh-interval').value
            };

            const saveRes = await fetch('/api/admin/general-website', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (saveRes.ok) {
                setStatus('Changes saved successfully!', 'success');
                if (url) urlInput.value = '';
                if (doIndex) loadDocs();
            } else { setStatus('Failed to update settings', 'error'); }
        } catch (e) { setStatus('Network Error', 'error'); }
        finally {
            btn.disabled = false;
            btn.innerHTML = oldContent;
        }
    });

    async function loadDocs() {
        try {
            const res = await fetch('/api/admin/documents');
            const data = await res.json();
            const webDocs = (data || []).filter(d => (d.filename || '').startsWith('[WEB]'));
            renderWebDocs(webDocs);
            if (!document.getElementById('content-indexed').classList.contains('hidden')) {
                updateCount(webDocs.length);
            }
        } catch (e) { console.error('Docs failed', e); }
    }

    function renderWebDocs(docs) {
        const list = document.getElementById('web-list');
        const empty = document.getElementById('indexed-empty');
        list.innerHTML = '';

        if (docs.length === 0) {
            empty.classList.remove('hidden');
            return;
        }
        empty.classList.add('hidden');

        docs.forEach(doc => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-slate-800/40 transition-colors group';

            const statusClass = doc.status === 'processed' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' :
                doc.status === 'processing' ? 'bg-amber-500/10 text-amber-500 border-amber-500/20' : 'bg-red-500/10 text-red-500 border-red-500/20';

            const filenameShort = doc.filename.replace('[WEB] ', '').split('/')[2] || doc.filename.replace('[WEB] ', '');

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="h-9 w-9 bg-indigo-500/10 rounded-lg flex items-center justify-center text-indigo-400 border border-indigo-500/20">
                        <i class="fa-solid fa-globe-americas"></i>
                    </div>
                    <div class="ml-4">
                        <div class="text-sm font-bold text-white truncate max-w-[200px] sm:max-w-md" title="${doc.filename}">${filenameShort}</div>
                        <div class="text-[10px] text-slate-600 font-black uppercase tracking-wider">ID: ${doc.id}</div>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">
                  <div class="flex flex-col items-center">
                    <span class="px-2 py-1 rounded-full text-[10px] font-black ${statusClass} uppercase tracking-tighter border opacity-70">${doc.status}</span>
                    <span class="text-[10px] text-slate-500 mt-1.5 font-black uppercase">${doc.chunk_count || 0} CHUNKS</span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right space-x-2">
                    <a href="/admin/chunks?document_id=${doc.id}" class="btn-icon inline-flex" title="View Chunks">
                      <i class="fa-solid fa-layer-group"></i>
                    </a>
                    <button onclick="deleteDoc(${doc.id})" class="btn-danger-ghost inline-flex" title="Delete Content">
                      <i class="fa-solid fa-trash-alt"></i>
                    </button>
                </td>
            `;
            list.appendChild(row);
        });
    }

    async function deleteDoc(id) {
        if (!confirm('Are you sure you want to delete this web memory?')) return;
        try {
            const res = await fetch(`/api/admin/documents/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadDocs();
                setStatus('Content removed', 'success');
            } else { alert('Delete failed'); }
        } catch (e) { alert('Request failed'); }
    }

    loadGeneralConfig();
    loadDocs();
</script>
{% endblock %}