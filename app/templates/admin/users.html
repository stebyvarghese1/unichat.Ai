{% extends "admin/base_admin.html" %}
{% block title %}Users - Admin Dashboard{% endblock %}
{% block content %}
<div class="bg-slate-900 rounded-xl shadow-2xl border border-slate-800 overflow-hidden w-full min-w-0">
  <div
    class="px-4 sm:px-6 py-4 border-b border-slate-800 bg-slate-800/30 flex flex-wrap justify-between items-center gap-2">
    <h2 class="text-base sm:text-lg font-semibold text-white truncate min-w-0">System Users</h2>
    <button type="button" onclick="loadUsers()" class="btn-icon shrink-0 text-slate-300 hover:text-white"
      title="Refresh"><i class="fa-solid fa-sync-alt"></i> Refresh</button>
  </div>
  <div class="overflow-x-auto hide-h-scrollbar min-w-0">
    <table class="min-w-full divide-y divide-slate-800">
      <thead class="bg-slate-800/50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest w-20">ID</th>
          <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest">Email</th>
          <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest w-32">Role</th>
          <th class="px-6 py-3 text-left text-xs font-black text-slate-500 uppercase tracking-widest">Created At</th>
        </tr>
      </thead>
      <tbody id="user-list" class="bg-slate-900 divide-y divide-slate-800"></tbody>
    </table>
    <div id="empty-state" class="hidden py-12 text-center">
      <i class="fa-solid fa-users text-4xl text-slate-700 mb-3"></i>
      <p class="text-slate-500">No users found.</p>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  async function loadUsers() {
    const tbody = document.getElementById('user-list');
    const emptyState = document.getElementById('empty-state');
    tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-slate-500 font-medium tracking-wide">Loading system topology...</td></tr>';
    try {
      const res = await fetch('/api/admin/users');
      let data = await res.json();
      data = data.sort((a, b) => {
        if (a.role === 'admin' && b.role !== 'admin') return -1;
        if (a.role !== 'admin' && b.role === 'admin') return 1;
        return new Date(b.created_at) - new Date(a.created_at);
      });
      tbody.innerHTML = '';
      if (data.length === 0) {
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
        data.forEach(user => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-slate-800/40 transition-colors group';

          let roleClass = 'bg-slate-800 text-slate-400 border border-slate-700';
          if (user.role === 'admin') {
            roleClass = 'bg-purple-500/10 text-purple-400 border border-purple-500/20';
          }

          const avatarClass = user.role === 'admin' ? 'bg-purple-500/20 text-purple-400' : 'bg-blue-500/20 text-blue-400';
          const adminBadge = user.role === 'admin' ? '<span class="ml-2 px-2 py-0.5 text-[10px] font-black uppercase tracking-tight rounded-full bg-purple-500/10 text-purple-400 border border-purple-500/20 inline-flex items-center"><i class="fa-solid fa-crown mr-1"></i> Admin</span>' : '';

          tr.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-mono">#${user.id}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">
              <div class="flex items-center">
                <div class="h-8 w-8 rounded-full ${avatarClass} flex items-center justify-center font-bold mr-3 text-xs border border-white/5">
                  ${user.email.substring(0, 2).toUpperCase()}
                </div>
                ${user.email}
                ${adminBadge}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="px-2 py-1 inline-flex text-[10px] font-black uppercase tracking-widest rounded-full ${roleClass}">
                ${user.role}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 font-medium">
              ${new Date(user.created_at).toLocaleDateString()}
            </td>
          `;
          if (user.role === 'admin') {
            tr.classList.add('bg-purple-500/[0.02]');
          }
          tbody.appendChild(tr);
        });
      }
    } catch (e) {
      tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-red-400 font-bold">CRITICAL: FAILED TO FETCH USERS</td></tr>';
    }
  }
  loadUsers();
</script>
{% endblock %}