<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - University AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 0.5px, transparent 0.5px);
            background-size: 24px 24px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .input-focus {
            transition: all 0.2s ease;
        }

        .input-focus:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 1rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-right: 2.5rem !important;
        }

        .status-animate {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark Mode Global Overrides */
        .dark-mode {
            background-color: #0f172a !important;
            color: #f1f5f9 !important;
            background-image: radial-gradient(#1e293b 0.5px, transparent 0.5px) !important;
        }

        .dark-mode .glass-card,
        .dark-mode header,
        .dark-mode #app-header,
        .dark-mode .bg-white,
        .dark-mode [class*="bg-white/"],
        .dark-mode [class*="bg-indigo-50/"],
        .dark-mode [class*="bg-blue-50/"] {
            background: rgba(30, 41, 59, 0.7) !important;
            background-color: #1e293b !important;
            border-color: #334155 !important;
            color: #f1f5f9 !important;
            box-shadow: none !important;
        }

        .dark-mode .text-slate-900,
        .dark-mode .text-slate-800,
        .dark-mode .text-slate-700,
        .dark-mode .text-slate-600 {
            color: #f1f5f9 !important;
        }

        .dark-mode .text-slate-500,
        .dark-mode .text-slate-400 {
            color: #94a3b8 !important;
        }

        .dark-mode .bg-slate-50,
        .dark-mode .bg-slate-100,
        .dark-mode .bg-blue-50,
        .dark-mode .bg-indigo-100 {
            background-color: #1e293b !important;
            border-color: #334155 !important;
        }

        .dark-mode .border-slate-200,
        .dark-mode .border-gray-200,
        .dark-mode .border-indigo-100,
        .dark-mode .border-rose-100 {
            border-color: #334155 !important;
        }

        .dark-mode input,
        .dark-mode select {
            background-color: #1e293b !important;
            color: #f1f5f9 !important;
            border-color: #334155 !important;
        }

        .dark-mode input:focus,
        .dark-mode select:focus {
            border-color: #818cf8 !important;
            box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.1) !important;
        }

        .dark-mode .bg-indigo-50 {
            background-color: #312e81 !important;
            color: #e0e7ff !important;
        }

        .dark-mode .bg-indigo-600 {
            background-color: #4338ca !important;
        }

        .dark-mode .text-indigo-600,
        .dark-mode .text-blue-600,
        .dark-mode .text-indigo-700 {
            color: #818cf8 !important;
        }

        .dark-mode .hover\:bg-indigo-50:hover,
        .dark-mode .hover\:bg-gray-50:hover,
        .dark-mode .hover\:bg-indigo-100:hover,
        .dark-mode .hover\:bg-rose-100:hover {
            background-color: #334155 !important;
        }

        .dark-mode .bg-rose-50 {
            background-color: #451a1a !important;
            color: #fecaca !important;
            border-color: #7f1d1d !important;
        }

        .dark-mode .text-rose-600 {
            color: #fb7185 !important;
        }

        /* Reset shadows for better look in dark mode */
        .dark-mode .shadow-lg,
        .dark-mode .shadow-md,
        .dark-mode .shadow-sm,
        .dark-mode .shadow-xl,
        .dark-mode .shadow-2xl,
        .dark-mode [class*="shadow-indigo-"],
        .dark-mode [class*="shadow-slate-"] {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2) !important;
        }

        .dark-mode .shadow-none {
            box-shadow: none !important;
        }
    </style>
</head>

<body class="min-h-screen text-slate-800">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50 backdrop-blur-md bg-white/70">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </div>
                <h1 class="text-xl font-extrabold tracking-tight text-slate-900">Account Settings</h1>
            </div>
            <a href="/chat"
                class="inline-flex items-center gap-2 px-4 py-2 text-sm font-bold text-indigo-600 hover:bg-indigo-50 rounded-xl transition-all border border-transparent hover:border-indigo-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back to Chat
            </a>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 sm:px-6 py-8 md:py-12">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <!-- Sidebar: User Info -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-card rounded-3xl p-6 shadow-sm overflow-hidden relative">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-50 rounded-full -mr-16 -mt-16 opacity-50">
                    </div>
                    <div class="relative">
                        <div
                            class="w-16 h-16 bg-gradient-to-tr from-indigo-500 to-purple-500 rounded-2xl flex items-center justify-center text-white text-2xl font-bold mb-4 shadow-xl shadow-indigo-100">
                            <span id="p-avatar">U</span>
                        </div>
                        <h2 class="text-xl font-bold text-slate-900 mb-1" id="p-email-display">User Name</h2>
                        <span
                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-indigo-100 text-indigo-700 uppercase tracking-wider"
                            id="p-role">Member</span>

                        <div class="mt-6 space-y-4">
                            <div class="flex items-center gap-3 text-sm">
                                <div
                                    class="w-8 h-8 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase font-bold text-slate-400 tracking-widest">Email
                                        Address</p>
                                    <p class="font-medium text-slate-700" id="p-email">--</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 text-sm">
                                <div
                                    class="w-8 h-8 rounded-lg bg-slate-50 flex items-center justify-center text-slate-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                </div>
                                <div>
                                    <p class="text-[10px] uppercase font-bold text-slate-400 tracking-widest">Joined On
                                    </p>
                                    <p class="font-medium text-slate-700" id="p-created">--</p>
                                </div>
                            </div>
                        </div>

                        <button id="logout-btn"
                            class="w-full mt-8 flex items-center justify-center gap-2 px-4 py-3 text-sm font-bold text-rose-600 bg-rose-50 hover:bg-rose-100 rounded-2xl transition-all border border-rose-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>

            <!-- Content: Settings -->
            <div class="lg:col-span-8 space-y-8">

                <!-- Chat Preferences Card -->
                <div class="glass-card rounded-3xl p-8 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-900">Chat Preferences</h2>
                            <p class="text-sm text-slate-500">Set your default academic context for smarter answers.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700 ml-1">Preferred Course</label>
                            <select id="pref-course"
                                class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-sm font-medium input-focus cursor-pointer appearance-none">
                                <option value="">Loading courses...</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-bold text-slate-700 ml-1">Preferred Semester</label>
                            <select id="pref-sem"
                                class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-sm font-medium input-focus cursor-pointer appearance-none">
                                <option value="">Select a course first</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-8 flex flex-col sm:flex-row items-center gap-4">
                        <button id="save-prefs"
                            class="w-full sm:w-auto px-8 py-3.5 bg-indigo-600 text-white font-bold rounded-2xl hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-all active:scale-[0.98]">
                            Save Preferences
                        </button>
                        <div id="prefs-status" class="status-animate text-sm font-medium h-5"></div>
                    </div>
                </div>

                <!-- Security Card -->
                <div class="glass-card rounded-3xl p-8 shadow-sm">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-12 h-12 bg-slate-100 text-slate-600 rounded-2xl flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-900">Password & Security</h2>
                            <p class="text-sm text-slate-500">Update your account password frequently.</p>
                        </div>
                    </div>

                    <form id="pwd-form" class="space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-slate-700 ml-1">Current Password</label>
                                <input type="password" id="current" placeholder="••••••••"
                                    class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-sm font-medium input-focus"
                                    required>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-sm font-bold text-slate-700 ml-1">New Password</label>
                                <input type="password" id="newpwd" placeholder="Min. 8 characters"
                                    class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 text-sm font-medium input-focus"
                                    required>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row items-center gap-4 pt-2">
                            <button type="submit"
                                class="w-full sm:w-auto px-8 py-3.5 bg-slate-800 text-white font-bold rounded-2xl hover:bg-slate-900 shadow-lg shadow-slate-100 transition-all active:scale-[0.98]">
                                Update Password
                            </button>
                            <div id="pwd-status" class="status-animate text-sm font-medium h-5"></div>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </main>

    <script>
        let allFilters = [];
        const cSel = document.getElementById('pref-course');
        const sSel = document.getElementById('pref-sem');

        function getCourses() {
            return (allFilters.filter(x => x.category === 'course' && x.value) || [])
                .sort((a, b) => (a.value || '').localeCompare(b.value || ''));
        }

        function getSemestersForCourse(courseValue) {
            if (!courseValue) return [];
            const course = allFilters.find(x => x.category === 'course' && x.value === courseValue);
            if (!course) return [];
            return (allFilters.filter(x => x.category === 'semester' && x.parent_id === course.id && x.value) || [])
                .sort((a, b) => (a.value || '').localeCompare(b.value || ''));
        }

        function fillSemesterDropdown() {
            if (!sSel) return;
            const courseVal = cSel ? cSel.value : '';
            const semesters = getSemestersForCourse(courseVal);

            if (semesters.length === 0) {
                sSel.innerHTML = '<option value="">All Semesters</option>';
            } else {
                sSel.innerHTML = '<option value="">All Semesters</option>' +
                    semesters.map(s => `<option value="${s.value}">${s.value}</option>`).join('');
            }
        }

        async function init() {
            try {
                const r = await fetch('/api/check-auth');
                const auth = await r.json();
                if (!auth.authenticated) { window.location.href = '/login'; return; }

                const profRes = await fetch('/api/profile');
                const prof = await profRes.json();

                document.getElementById('p-email').innerText = prof.email || '';
                document.getElementById('p-email-display').innerText = prof.email ? prof.email.split('@')[0] : 'User';
                document.getElementById('p-avatar').innerText = prof.email ? prof.email[0].toUpperCase() : 'U';
                document.getElementById('p-role').innerText = prof.role || 'Member';
                document.getElementById('p-created').innerText = prof.created_at ? new Date(prof.created_at).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }) : '--';

                const fRes = await fetch('/api/filters');
                const filters = await fRes.json();
                allFilters = filters.all || [];

                const courses = getCourses();
                if (cSel) {
                    cSel.innerHTML = '<option value="">All Courses</option>' +
                        courses.map(c => `<option value="${c.value}">${c.value}</option>`).join('');
                    cSel.addEventListener('change', fillSemesterDropdown);
                }

                const pRes = await fetch('/api/prefs');
                const prefs = await pRes.json();

                if (prefs.course && cSel) cSel.value = prefs.course;
                fillSemesterDropdown();
                if (prefs.semester && sSel) sSel.value = prefs.semester;
            } catch (e) {
                console.error('Initialization failed', e);
            }
        }

        init();

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login';
        });

        // Form handlers with improved UI feedback
        function showStatus(elId, msg, isError = false) {
            const el = document.getElementById(elId);
            el.innerText = msg;
            el.className = `status-animate text-sm font-medium ${isError ? 'text-rose-500' : 'text-emerald-500'}`;
            setTimeout(() => { el.innerText = ''; }, 4000);
        }

        document.getElementById('pwd-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const current = document.getElementById('current').value;
            const newpwd = document.getElementById('newpwd').value;

            try {
                const res = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: current, new_password: newpwd })
                });
                const data = await res.json();
                if (res.ok) {
                    showStatus('pwd-status', '✓ Password updated successfully');
                    document.getElementById('current').value = '';
                    document.getElementById('newpwd').value = '';
                } else {
                    showStatus('pwd-status', data.error || 'Failed to update', true);
                }
            } catch (e) {
                showStatus('pwd-status', 'Network error', true);
            }
        });

        document.getElementById('save-prefs').addEventListener('click', async () => {
            const course = cSel.value || '';
            const semester = sSel.value || '';
            try {
                const res = await fetch('/api/prefs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ course, semester })
                });
                if (res.ok) {
                    showStatus('prefs-status', '✓ Preferences saved');
                } else {
                    showStatus('prefs-status', 'Failed to save', true);
                }
            } catch (e) {
                showStatus('prefs-status', 'Network error', true);
            }
        });

        // Theme sync
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }
    </script>
</body>

</html>